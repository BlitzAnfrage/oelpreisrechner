<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ölpreisrechner – Bestellung</title>
  <style>
    :root{
      --brand:#6EC054;--brand-dark:#4c7f2d;--bg:#fafafa;--ink:#333;--ink-soft:#555;--card:#fff;
      --ok:#2f7d1f;--ok-bg:#eaf7e6;--err:#a10000;--err-bg:#fff1f1;--ring:rgba(96,153,59,.3);
      --shadow:0 6px 25px rgba(0,0,0,.07);
    }
    *{box-sizing:border-box}
    body { margin: 0; font-family: Arial, sans-serif; background-color: var(--bg); color: var(--ink); line-height: 1.5; }

    header { background-color: var(--brand); position: relative; padding: 35px 60px; text-align: center; }
    .logo { height: 40px; }
    .back-button { background-color: white; color: var(--brand); padding: 10px 20px; border: none; border-radius: 20px; font-weight: 600; text-decoration: none; transition: background-color 0.2s ease; position: absolute; right: 60px; top: 50%; transform: translateY(-50%); }
    .back-button:hover { background-color: #e6f0d9; }

    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Ergebnisbereich */
    #result-wrap { max-width: 1000px; margin: 30px auto 0; padding: 0 16px; }
    #webhook-result { padding: 18px 20px; background-color: #f9fff1; border: 2px solid var(--brand); border-radius: 14px; box-shadow: 0 6px 15px rgba(110,192,84,0.2); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 1rem; color: var(--brand-dark); animation: fadeInDown 0.4s ease forwards; }
    #webhook-result .row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;align-items:center}
    #webhook-result .metric{background:#fff;border:1px solid #e6eedf;border-radius:10px;padding:10px 12px}
    #webhook-result .metric .k{display:block;font-size:.8rem;color:#6b8060}
    #webhook-result .metric .v{font-weight:800;font-size:1.1rem;color:#27461a}

    /* Premium Toggle */
    .premium { display:flex; align-items:center; gap:10px; margin: 14px 0 6px; }
    .premium input{ transform: scale(1.1); }
    .premium .hint{ color: var(--ink-soft); font-size: .95rem; }

    /* Positions-Tabelle */
    .table { width:100%; border-collapse: collapse; margin-top: 8px; border:1px solid #e5e5e5; border-radius: 10px; overflow: hidden; }
    .table thead th{ background:#f7fbf2; color:#2f4b24; font-weight:700; text-align:left; padding:10px 12px; border-bottom:1px solid #e5e5e5; }
    .table td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; }
    .table tfoot td{ background:#fbfef8; font-weight:700; }

    /* Formularcontainer */
    .form-container { max-width: 1000px; margin: 20px auto 40px auto; padding: 32px 24px 40px; background: var(--card); border-radius: 16px; box-shadow: var(--shadow); border: 2px solid #e5e5e5; font-family: 'Segoe UI', sans-serif; animation: fadeInUp 0.4s ease forwards; }
    h2#bestellformular { margin-top: 0; margin-bottom: 18px; font-weight: 700; color: var(--brand-dark); }
    .section h3{ margin: 22px 0 10px; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 10px 12px; font-size: 15px; border: 1.8px solid #ccc; border-radius: 10px; outline: none; transition: border-color 0.2s, box-shadow .2s; font-family: 'Segoe UI', sans-serif; min-height: 38px; }
    textarea { min-height: 80px; resize: vertical; }
    input:focus, select:focus, textarea:focus { border-color: var(--brand-dark); box-shadow: 0 0 0 4px var(--ring); }

    button { width: 100%; background: var(--brand); color: white; padding: 14px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s, transform .02s; margin-top: 22px; box-shadow: 0 6px 12px rgba(110,192,84,0.4); }
    button:hover, button:focus { background: var(--brand-dark); outline: none; }
    button:active{ transform: translateY(1px); }

    .checkbox-group { margin-bottom: 12px; font-weight: 500; }
    .checkbox-group input[type="checkbox"] { margin-right: 10px; transform: scale(1.1); vertical-align: middle; cursor: pointer; }

    .alert { max-width: 1000px; margin: 10px auto 0; padding: 10px 14px; border-radius: 8px; font-size: .95rem; display:none; }
    .alert.ok { background:var(--ok-bg); color:var(--ok); border:1px solid var(--brand); }
    .alert.err { background:var(--err-bg); color:var(--err); border:1px solid #ffb3b3; }

    @media (max-width: 1000px) {
      header { padding: 30px 30px; }
      .back-button { right: 30px; }
      #webhook-result .row{grid-template-columns:1fr}
      .form-container { padding: 24px 16px 32px; margin: 22px 15px 40px; }
      #result-wrap{padding:0 12px}
    }
  </style>
</head>
<body>
  <header>
    <img src="https://onecdn.io/media/61c27ecc-efc9-4840-9ff3-d13f96ec1316/full" alt="Logo" class="logo" />
    <a href="index.html" class="back-button">Zurück zum Rechner</a>
  </header>

  <!-- Ergebnis vom Rechner (aus index.html via sessionStorage) -->
  <div id="result-wrap">
    <section id="webhook-result" aria-live="polite" aria-atomic="true">
      <div class="row">
        <div class="metric"><span class="k">Menge</span><span id="m-menge" class="v">–</span></div>
        <div class="metric"><span class="k">Preis / 100 L</span><span id="m-pp100" class="v">–</span></div>
        <div class="metric"><span class="k">Preis / L</span><span id="m-ppl" class="v">–</span></div>
      </div>

      <label class="premium" title="Premium-Heizöl kostet zusätzlich 1,50 € je 100 Liter.">
        <input type="checkbox" id="optPremium"> Premium‑Heizöl hinzufügen (+1,50 € / 100 L)
        <span class="hint" id="premiumHint"></span>
      </label>

      <table class="table" aria-label="Preisübersicht">
        <thead>
          <tr><th>Menge</th><th>Beschreibung</th><th>Einzelpreis</th><th>Gesamt</th></tr>
        </thead>
        <tbody id="posBody"></tbody>
        <tfoot>
          <tr><td colspan="3">Zwischensumme (netto)</td><td id="sumNet">–</td></tr>
          <tr><td colspan="3">MwSt <span id="mwstRate">19%</span></td><td id="sumVat">–</td></tr>
          <tr><td colspan="3">Gesamtsumme (brutto)</td><td id="sumGross">–</td></tr>
        </tfoot>
      </table>
    </section>
  </div>

  <div id="alert-ok" class="alert ok">Bestellung erfolgreich übermittelt. Wir melden uns zeitnah mit dem finalen Angebot.</div>
  <div id="alert-err" class="alert err">Es gab ein Problem beim Senden. Bitte versuche es erneut oder kontaktiere uns.</div>

  <!-- Bestellformular -->
  <main class="form-container" role="main" aria-labelledby="bestellformular">
    <h2 id="bestellformular">Bestellung Heizöl</h2>
    <form id="orderForm" novalidate>
      <!-- Honeypot gegen Bots (nicht ausfüllen) -->
      <div style="position:absolute;left:-5000px;top:auto;width:1px;height:1px;overflow:hidden;">
        <label>Bitte nicht ausfüllen: <input type="text" id="hp_field" name="company" tabindex="-1" autocomplete="off"></label>
      </div>

      <section class="section" aria-label="Kundendaten">
        <h3>Kundendaten</h3>
        <div class="form-group">
          <label for="vorname">Vorname <span class="required">*</span></label>
          <input type="text" id="vorname" name="vorname" required autocomplete="given-name" />
        </div>
        <div class="form-group">
          <label for="nachname">Nachname <span class="required">*</span></label>
          <input type="text" id="nachname" name="nachname" required autocomplete="family-name" />
        </div>
        <div class="form-group">
          <label for="firma">Firma</label>
          <input type="text" id="firma" name="firma" autocomplete="organization" />
        </div>
        <div class="form-group">
          <label for="plz">Postleitzahl <span class="required">*</span></label>
          <input type="text" id="plz" name="plz" pattern="\d{5}" required autocomplete="postal-code" />
        </div>
        <div class="form-group">
          <label for="stadt">Stadt <span class="required">*</span></label>
          <input type="text" id="stadt" name="stadt" required autocomplete="address-level2" />
        </div>
        <div class="form-group">
          <label for="email">E-Mail <span class="required">*</span></label>
          <input type="email" id="email" name="email" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="telefon">Telefonnummer <span class="required">*</span></label>
          <input type="tel" id="telefon" name="telefon" pattern="[\+0-9\s\-]{6,20}" required autocomplete="tel" />
        </div>
      </section>

      <section class="section" aria-label="Bestelldetails">
        <h3>Bestelldetails</h3>
        <div class="form-group">
          <label for="zahlungsmethode">Zahlungsmethode <span class="required">*</span></label>
          <select id="zahlungsmethode" name="zahlungsmethode" required>
            <option value="" disabled selected>Bitte wählen</option>
            <option value="rechnung">Rechnung</option>
            <option value="lastschrift">Lastschrift</option>
            <option value="paypal">PayPal</option>
            <option value="kreditkarte">Kreditkarte</option>
          </select>
        </div>
        <div class="form-group">
          <label for="lieferzeit">Lieferzeit <span class="required">*</span></label>
          <select id="lieferzeit" name="lieferzeit" required>
            <option value="" disabled selected>Bitte wählen</option>
            <option value="sofort">Sofort</option>
            <option value="1-3 tage">1-3 Tage</option>
            <option value="nach absprache">Nach Absprache</option>
          </select>
        </div>
        <div class="form-group">
          <label for="bemerkungen">Bemerkungen</label>
          <textarea id="bemerkungen" name="bemerkungen" placeholder="Hier können Sie zusätzliche Informationen eingeben..."></textarea>
        </div>
      </section>

      <section class="section" aria-label="Optionen">
        <div class="checkbox-group">
          <input type="checkbox" id="agb" name="agb" required />
          <label for="agb">AGB akzeptieren <span class="required">*</span></label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="newsletter" name="newsletter" />
          <label for="newsletter">Newsletter abonnieren</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="abo-info" name="abo_info" />
          <label for="abo-info">Ich möchte die Lieferpauschale sparen. Bitte informieren Sie mich unverbindlich über die Möglichkeiten des Heizöl-Abos!</label>
        </div>
      </section>

      <button type="submit" class="submit-btn" aria-label="Bestellung absenden">Jetzt Bestellung absenden</button>
      <p id="orderStatus" class="info" style="display:none;margin-top:10px"></p>
    </form>
  </main>

  <script>
    // === Einstellungen ===
    const ORDER_WEBHOOK_URL = 'https://n8n.srv899952.hstgr.cloud/webhook/oelrechner-bestellung'; // ggf. anpassen
    const PREMIUM_SURCHARGE_PER_100L = 1.50; // € je 100 L

    // Format-Helfer
    const euro = (v) => (Number(v)||0).toLocaleString('de-DE', { style:'currency', currency:'EUR' });
    const liter = (v) => (Number(v)||0).toLocaleString('de-DE') + ' L';

    function pickBerechnung(obj){
      if (!obj) return {};
      if (Array.isArray(obj.response) && obj.response.length) return obj.response[0];
      return obj;
    }

    function calcTotals(base, premium){
      const mengeL = Number(base.eingabe?.liefermenge || base.liefermenge || 0);
      const pauschaleCent = Number(base.berechnung?.pauschaleCent ?? base.pauschaleCent ?? Math.round((Number(base.berechnung?.gesamtMarge ?? base.gesamtMarge || 0))*100));
      const mwstSatz = Number(base.berechnung?.mwstSatz ?? base.mwstSatz ?? 0.19);

      const preis100Base = Number(base.berechnung?.preisProEinheit ?? base.preisProEinheit || 0);
      const preis100 = preis100Base + (premium ? PREMIUM_SURCHARGE_PER_100L : 0);
      const preisLiter = preis100 / 100;

      const nettoOelCent = Math.round(mengeL * preis100);
      const nettoSummeCent = nettoOelCent + pauschaleCent;
      const mwstCent = Math.round(nettoSummeCent * (mwstSatz >= 0 && mwstSatz <= 1 ? mwstSatz : 0.19));
      const bruttoCent = nettoSummeCent + mwstCent;

      return {
        mengeL,
        preis100,
        preisLiter,
        pauschaleCent,
        mwstSatz: (mwstSatz >= 0 && mwstSatz <= 1 ? mwstSatz : 0.19),
        nettoOelCent,
        nettoSummeCent,
        mwstCent,
        bruttoCent
      };
    }

    function renderPositions(t, berechnung){
      const tbody = document.getElementById('posBody');
      tbody.innerHTML = '';

      // Position 1: Öl
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `
        <td>${liter(t.mengeL)}</td>
        <td>Heizöl EL schwefelarm • DIN 51603-1</td>
        <td>${t.preis100.toLocaleString('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2})} € / 100 L</td>
        <td>${euro(t.nettoOelCent/100)}</td>`;
      tbody.appendChild(tr1);

      // Position 2: Pauschale (falls > 0)
      if ((t.pauschaleCent||0) > 0){
        const tr2 = document.createElement('tr');
        tr2.innerHTML = `
          <td>1</td>
          <td>Gefahrgutzuschlag / Lieferpauschale</td>
          <td>${euro(t.pauschaleCent/100)}</td>
          <td>${euro(t.pauschaleCent/100)}</td>`;
        tbody.appendChild(tr2);
      }

      // Summen
      document.getElementById('sumNet').textContent   = euro(t.nettoSummeCent/100);
      document.getElementById('sumVat').textContent   = euro(t.mwstCent/100);
      document.getElementById('sumGross').textContent = euro(t.bruttoCent/100);
      document.getElementById('mwstRate').textContent = Math.round((t.mwstSatz||0.19)*100) + '%';

      // Header-Metriken
      document.getElementById('m-menge').textContent = liter(t.mengeL);
      document.getElementById('m-pp100').textContent = `${t.preis100.toLocaleString('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2})} €`;
      document.getElementById('m-ppl').textContent   = `${t.preisLiter.toLocaleString('de-DE',{minimumFractionDigits:3, maximumFractionDigits:3})} €`;

      // Premium-Hinweis
      const preis100Base = Number(berechnung?.preisProEinheit || 0);
      const diff = t.preis100 - preis100Base;
      document.getElementById('premiumHint').textContent = diff > 0 ? `(+${diff.toLocaleString('de-DE',{minimumFractionDigits:2, maximumFractionDigits:2})} € gesamt je 100 L)` : '';
    }

    function renderAll(premium=false){
      let data = null; try { const raw = sessionStorage.getItem('oelForm'); if (raw) data = JSON.parse(raw); } catch {}
      const eingabe = data?.eingabe || {};
      const berechnungRaw = pickBerechnung(data?.berechnung || {});
      const base = { eingabe, berechnung: berechnungRaw, ...berechnungRaw };

      const totals = calcTotals(base, premium);
      renderPositions(totals, berechnungRaw);

      // Prefill PLZ im Formular
      if (eingabe.plz) document.getElementById('plz').value = eingabe.plz;

      return { eingabe, berechnungRaw, totals };
    }

    function showAlert(id, on=true){ const el = document.getElementById(id); if(!el) return; el.style.display = on ? 'block' : 'none'; }

    document.addEventListener('DOMContentLoaded', () => {
      const premiumToggle = document.getElementById('optPremium');
      let last = renderAll(false);

      premiumToggle.addEventListener('change', () => {
        last = renderAll(premiumToggle.checked);
      });

      const form = document.getElementById('orderForm');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        showAlert('alert-ok', false); showAlert('alert-err', false);

        const hp = document.getElementById('hp_field');
        if (hp && hp.value) { showAlert('alert-err', true); return; }

        const requiredIds = ['vorname','nachname','plz','stadt','email','telefon','zahlungsmethode','lieferzeit','agb'];
        for (const id of requiredIds) {
          const el = document.getElementById(id);
          if (!el) continue;
          if ((el.type === 'checkbox' && !el.checked) || (!el.value)) {
            el.focus();
            showAlert('alert-err', true);
            return;
          }
        }

        // Payload aufbauen (inkl. Premium + neu berechnete Summen)
        const premium = document.getElementById('optPremium').checked;
        const { eingabe, berechnungRaw, totals } = last;

        const payload = {
          orderId: 'ORD-' + Date.now(),
          premium,
          premiumSurchargePer100L: PREMIUM_SURCHARGE_PER_100L,
          totals, // enthält alle Cent-Werte & Preise
          kundendaten: {
            vorname: document.getElementById('vorname').value.trim(),
            nachname: document.getElementById('nachname').value.trim(),
            firma: document.getElementById('firma').value.trim(),
            plz: document.getElementById('plz').value.trim(),
            stadt: document.getElementById('stadt').value.trim(),
            email: document.getElementById('email').value.trim(),
            telefon: document.getElementById('telefon').value.trim(),
          },
          bestelldetails: {
            zahlungsmethode: document.getElementById('zahlungsmethode').value,
            lieferzeit: document.getElementById('lieferzeit').value,
            bemerkungen: document.getElementById('bemerkungen').value.trim(),
            agb: document.getElementById('agb').checked,
            newsletter: document.getElementById('newsletter').checked,
            abo_info: document.getElementById('abo-info').checked
          },
          eingabe,
          berechnung: berechnungRaw,
          meta: {
            ts: new Date().toISOString(),
            page: location.href,
            userAgent: navigator.userAgent
          }
        };

        const fd = new FormData();
        fd.append('payload', JSON.stringify(payload));

        try {
          const res = await fetch(ORDER_WEBHOOK_URL, { method: 'POST', body: fd });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          let reply = null; try { reply = await res.json(); } catch {}

          if (reply && (reply.ok === true || reply.success === true)){
            showAlert('alert-ok', true);
            document.getElementById('orderStatus').textContent = `Bestellung erfolgreich übermittelt. Bestell-ID: ${reply.orderId || payload.orderId}`;
            document.getElementById('orderStatus').style.display = 'block';
            sessionStorage.setItem('lastOrderId', reply.orderId || payload.orderId);
          } else {
            showAlert('alert-err', true);
            document.getElementById('orderStatus').textContent = 'Bestellung gesendet, aber Serverantwort war unerwartet.';
            document.getElementById('orderStatus').style.display = 'block';
          }
        } catch (err){
          console.error(err);
          showAlert('alert-err', true);
          document.getElementById('orderStatus').textContent = 'Senden fehlgeschlagen. Bitte später erneut versuchen.';
          document.getElementById('orderStatus').style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>
