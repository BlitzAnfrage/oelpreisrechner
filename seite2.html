<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preisübersicht – Heizöl</title>
  <link rel="icon" href="https://onecdn.io/media/96d496c9-3b9e-451e-ab59-264290e9b0cf/full" sizes="any" />
  <meta name="theme-color" content="#6EC054" />
  <style>
    :root{
      --brand:#6EC054; --brand-2:#4c7f2d; --ink:#1f2b1c; --bg:#f7faf7; --card:#fff;
      --muted:#66736a; --ring:rgba(110,192,84,.25); --shadow:0 12px 30px rgba(0,0,0,.08);
      --ok:#1f7a1f; --ok-bg:#e7f6e7; --err:#7a1f1f; --err-bg:#fbe9e9;
    }
    *{box-sizing:border-box}
    html{font-size:15px;overflow-x:hidden}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--ink);overflow-x:hidden}
    header{background:var(--brand);padding:22px 18px;color:#fff;display:flex;align-items:center;justify-content:center}
    .logo{height:34px}

    .wrap{max-width:1040px;margin:0 auto;padding:18px}

    .hero{background:#fff;border:1px solid #e8efe3;border-radius:14px;box-shadow:var(--shadow);padding:14px 16px;margin:16px auto}
    .hero h1{margin:.2rem 0;color:#184b10;font-size:clamp(1.2rem,2.2vw,1.6rem)}
    .hero p{margin:.25rem 0 .4rem;color:#2a2d29}
    .hero-notes{margin-top:.5rem}
    .overlay-lead{margin:0 0 6px;color:#184b10;font-weight:800}
    .overlay-list{list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:10px}
    .overlay-list li{display:inline-flex;align-items:center;gap:6px;background:#fbfdf9;border:1px solid #e8efe3;border-radius:999px;padding:6px 10px;font-weight:700;color:#184b10}
    .overlay-list li::before{content:'✓';font-weight:900}

    .price-hero{position:relative;display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:stretch;margin:16px 0}
    .price-hero .card{background:linear-gradient(180deg,#ffffff 0%, #fbfffb 100%);border:1px solid #e8efe3;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .price-hero .main{padding:18px 18px}
    .title-over-price{margin:0 0 8px;color:#184b10;font-size:clamp(1.3rem,2.4vw,1.6rem)}
    .sup{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
    .sup .badge{display:inline-flex;gap:6px;align-items:center;background:#e8f6e4;border:1px solid #cfeacc;color:#13470e;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}
    .price{font-size:clamp(1.8rem,5vw,2.6rem);font-weight:900;margin:.2rem 0;color:#0e3d08}
    .price small{font-weight:700;color:#2e4f25;font-size:.9rem}
    .meta{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .kv{background:#fff;border:1px solid #e8efe3;border-radius:12px;padding:10px 12px}
    .kv .k{display:block;color:#6a766f;font-size:.8rem}
    .kv .v{display:block;font-weight:800}
    .aside{padding:18px 18px}
    .aside .rows{display:grid;gap:10px}
    .row{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dashed #eef2ee}
    .row:last-child{border-bottom:0}
    .k{color:var(--muted)} .v{font-weight:800}
    .hint{color:#6a766f;font-size:.9rem;margin:6px 0 0}

    .card{background:var(--card);border:1px solid #e8efe3;border-radius:14px;box-shadow:var(--shadow)}
    .card .hdr{padding:14px 16px;border-bottom:1px solid #eef3ec;display:flex;align-items:center;justify-content:space-between}
    .card .body{padding:12px 16px}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#e8f6e4;border:1px solid #cfeacc;color:#13470e;border-radius:999px;padding:4px 10px;font-weight:700;font-size:.78rem}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){.price-hero{grid-template-columns:1fr}.meta{grid-template-columns:1fr 1fr}.grid{grid-template-columns:1fr}}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:#184b10;border:1.6px solid #cfeacc}
    .btn:focus{outline:4px solid var(--ring)}

    .newsletter{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center;background:#fbfdf9;border:1px solid #e8efe3;border-radius:12px;padding:12px; margin:16px 0}
    .newsletter img{width:100%;height:auto;border-radius:10px;display:block}
    .newsletter .title{font-weight:800;margin:0;color:#184b10}
    .newsletter p{margin:.25rem 0;color:#2a2d29}
    .checkline{display:flex;align-items:flex-start;gap:10px;margin-top:6px}
    @media (max-width:820px){.newsletter{margin:14px 0 0}}

    .order-card .body{padding:16px}
    .order-form{display:grid;gap:16px}
    .fieldset{border:1px solid #e8efe3;border-radius:12px;padding:14px;background:#fbfdf9}
    .legend-title{font-weight:700;margin:0 0 12px;color:#184b10}
    .choices{display:flex;flex-wrap:wrap;gap:10px}
    .choice{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #d9e3d3;border-radius:10px;padding:8px 12px}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;column-gap:16px;row-gap:16px;align-items:start}
    .form-grid>div{display:flex;flex-direction:column;gap:6px}
    .form-grid .form-grid{grid-column:1 / -1}
    .form-grid .form-grid>div{display:flex;flex-direction:column;gap:6px}
    @media (max-width:820px){.form-grid{grid-template-columns:1fr}}

    label{font-weight:600;font-size:.92rem;margin:0;color:#1f2b1c}
    input[type="text"], input[type="email"], input[type="tel"], textarea, select{border:1.7px solid #d9e3d3;border-radius:10px;padding:10px 12px;font-size:.95rem;outline:none;transition:.2s;background:#fff}
    textarea{min-height:100px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:var(--brand-2);box-shadow:0 0 0 4px var(--ring)}

    .footer{margin-top:34px;background:var(--brand);color:#fff;text-align:center;padding:24px 12px;font-size:.95rem}
    .footer a{color:#fff;text-decoration:underline}

    .order-card .hdr{background:var(--brand);color:#fff;border-radius:12px 12px 0 0;border-bottom:none}
    .order-card .hdr strong{color:#fff}

    #premiumBadge[hidden]{display:none !important}

    /* ===== Bestellbestätigung (Toast + Modal) ===== */
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:var(--ok-bg);color:var(--ok);border:1px solid #cde9cd;border-radius:12px;padding:10px 14px;box-shadow:var(--shadow);display:none;z-index:60;font-weight:700}
    .toast.err{background:var(--err-bg);color:var(--err);border-color:#f1c7c7}

    .confirm{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .confirm[aria-hidden="false"]{display:flex}
    .confirm .panel{background:#fff;border-radius:16px;border:1px solid #e8efe3;box-shadow:var(--shadow);max-width:680px;width:100%;overflow:hidden}
    .confirm .head{background:var(--brand);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:10px}
    .confirm .head .check{width:24px;height:24px;border-radius:999px;background:#fff;color:#1f4d12;display:inline-flex;align-items:center;justify-content:center;font-weight:900}
    .confirm .body{padding:14px 16px}
    .confirm .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .confirm table{width:100%;border-collapse:collapse}
    .confirm td{padding:6px;border-bottom:1px dashed #e9efe7;vertical-align:top}
    .confirm .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .confirm .btn{border-radius:10px}

    /* === Print nur das Bestätigungs-Panel === */
    @media print {
      /* Standard: alles ausblenden */
      body.print-only-confirm * {
        visibility: hidden !important;
      }
      /* Nur das Panel sichtbar + sauber positioniert */
      body.print-only-confirm #confirm[aria-hidden="false"] .panel,
      body.print-only-confirm #confirm[aria-hidden="false"] .panel * {
        visibility: visible !important;
      }
      body.print-only-confirm #confirm[aria-hidden="false"] .panel {
        position: absolute !important;
        top: 0; left: 0; right: 0;
        margin: 0 auto;
        box-shadow: none !important;
        border: none !important;
        max-width: 100% !important;
      }
      /* Overlay-Hintergrund im Druck nicht zeigen */
      body.print-only-confirm #confirm[aria-hidden="false"] {
        background: transparent !important;
      }

      @page { size: A4; margin: 12mm; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* Zusätzliche Mobile-Optimierung */
    @media (max-width:600px){
      header{padding:16px 12px}
      .wrap{padding:12px}
      .hero{padding:12px}
      .card .hdr{padding:12px 14px}
      .card .body{padding:12px 14px}
      .actions{flex-direction:column;width:100%}
      .actions .btn{width:100%;text-align:center}
      .aside{padding:14px}
      .row{flex-direction:column;align-items:flex-start}
      .confirm .grid2{grid-template-columns:1fr}
      .newsletter{grid-template-columns:1fr}
    }

    /* ===== NUR hinzugefügt: Chart UI (ohne bestehende Styles zu verändern) ===== */
    .chart-card{margin:14px 0 0;background:#fff;border:1px solid #e8efe3;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .chart-head{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid #eef3ec;flex-wrap:wrap}
    .chart-title{font-weight:900;color:#184b10;font-size:1.05rem}
    .chart-sub{color:#66736a;font-weight:600;font-size:.9rem;margin-top:2px}
    .chart-actions{display:flex;gap:8px;flex-wrap:wrap}
    .rbtn{border:1.6px solid #cfeacc;background:#fff;color:#184b10;border-radius:999px;padding:7px 12px;font-weight:800;cursor:pointer}
    .rbtn.is-active{background:var(--brand);border-color:var(--brand);color:#fff}
    .rbtn:focus{outline:4px solid var(--ring)}
    .chart-wrap{padding:10px 14px 14px;height:260px}
    @media (max-width:820px){ .chart-wrap{height:220px} }
  </style>

  <!-- NUR hinzugefügt: Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <img class="logo" src="https://onecdn.io/media/61c27ecc-efc9-4840-9ff3-d13f96ec1316/full" alt="Raiffeisen Logo" />
  </header>

  <div class="wrap">
    <section class="hero">
      <h1>Preisübersicht & Bestellung</h1>
      <div class="hero-notes">
        <p class="overlay-lead">Nach Ihrer Bestellung rufen wir Sie zeitnah an und vereinbaren einen individuellen Liefertermin.</p>
        <ul class="overlay-list" aria-label="Leistungsmerkmale">
          <li>Individuelle Terminvereinbarung</li>
          <li>Tankwagengröße inkl. kleiner TKW</li>
          <li>Schlauchlänge bis 40&nbsp;m</li>
          <li>Exklusiv: verkürzte Lieferzeit</li>
        </ul>
      </div>
    </section>

    <section class="price-hero" aria-label="Preisübersicht">
      <div class="card main" aria-live="polite">
        <h1 class="title-over-price">Ergebnis Heizölpreis</h1>
        <div class="sup">
          <span class="badge">Brutto Gesamt</span>
          <span class="badge" id="premiumBadge" hidden>Premium</span>
        </div>
        <div class="price" id="priceBig">—</div>
        <div class="meta" role="list">
          <div class="kv" role="listitem"><span class="k">Gesamtpreis netto</span><span class="v" id="priceNetMain">—</span></div>
          <div class="kv" role="listitem"><span class="k">Preis je 100&nbsp;L (netto)</span><span class="v" id="preis100Net">—</span></div>
          <div class="kv" role="listitem"><span class="k">Preis je 100&nbsp;L (brutto)</span><span class="v" id="preis100Brutto">—</span></div>
        </div>
        <p class="hint" id="expressHint" style="display:none">inkl. Expresszuschlag</p>
        <p class="hint" id="invoiceHint" style="display:none">inkl. Aufpreis Zahlung auf Rechnung</p>
      </div>
      <aside class="card aside">
        <div class="rows">
          <div class="row"><div class="k">PLZ</div><div class="v" id="plz">—</div></div>
          <div class="row"><div class="k">Liefermenge</div><div class="v" id="liefermenge">—</div></div>
          <div class="row"><div class="k">Abladestellen</div><div class="v" id="ablade">—</div></div>
          <div class="row"><div class="k">Warenwert netto</div><div class="v" id="warenwert">—</div></div>
          <div class="row"><div class="k">Lieferpauschale</div><div class="v" id="pauschale">—</div></div>
          <div class="row"><div class="k">Zwischensumme netto</div><div class="v" id="netto">—</div></div>
          <div class="row" id="invoiceRow" style="display:none"><div class="k">Aufpreis Rechnung</div><div class="v" id="invoice">—</div></div>
          <div class="row" id="expressRow" style="display:none"><div class="k">Expresszuschlag</div><div class="v" id="express">—</div></div>
          <div class="row"><div class="k">MwSt.</div><div class="v" id="mwst">—</div></div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn" id="btnPrint" type="button">PDF / Drucken</button>
          <a class="btn secondary" href="./index.html">Neue Berechnung</a>
        </div>
        <p class="hint">Alle Angaben ohne Gewähr.</p>
      </aside>
    </section>

    <!-- NUR hinzugefügt: Chart-Block -->
    <section class="chart-card" aria-label="Ölpreisverlauf">
      <div class="chart-head">
        <div>
          <div class="chart-title">Ölpreisverlauf</div>
          <div id="oilChartMeta2" class="chart-sub">Lade Daten…</div>
        </div>
        <div class="chart-actions" role="group" aria-label="Zeitraum wählen">
          <button type="button" class="rbtn is-active" data-range="3m">3M</button>
          <button type="button" class="rbtn" data-range="6m">6M</button>
          <button type="button" class="rbtn" data-range="1y">1Y</button>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="oilChart2"></canvas>
      </div>
    </section>

    <div class="card order-card" style="margin-top:14px">
      <div class="hdr"><strong>Jetzt verbindlich bestellen</strong></div>
      <div class="body">
        <form class="order-form" id="orderForm" novalidate>
          <section class="fieldset">
            <p class="legend-title">Zahlungsmethode</p>
            <div class="choices">
              <label class="choice"><input type="radio" name="payment" value="Barzahlung" required> Barzahlung</label>
              <label class="choice"><input type="radio" name="payment" value="EC-Karte"> EC-Karte</label>
              <label class="choice"><input type="radio" name="payment" value="Vorabüberweisung"> Vorabüberweisung</label>
              <label class="choice"><input type="radio" name="payment" value="Rechnung"> Rechnung <small>(+0,02 € / L)</small></label>
            </div>
          </section>

          <section class="fieldset">
            <p class="legend-title">Lieferzeit</p>
            <div class="choices">
              <label class="choice"><input type="radio" name="delivery" value="ca. 2-3 Wochen" required> ca. 2–3 Wochen</label>
              <label class="choice"><input type="radio" name="delivery" value="1-2 Werktage (Express)"> 1–2 Werktage <small>Express (ca. 100 € - Preis auf Anfrage)</small></label>
            </div>
          </section>

          <section class="fieldset">
            <p class="legend-title">Kundendaten</p>
            <div class="form-grid">
              <div>
                <label for="fn">Vorname *</label>
                <input id="fn" name="vorname" type="text" required>
              </div>
              <div>
                <label for="ln">Name *</label>
                <input id="ln" name="name" type="text" required>
              </div>
              <div>
                <label for="company">Firma</label>
                <input id="company" name="firma" type="text">
              </div>
              <div>
                <label for="addr">Adresse *</label>
                <input id="addr" name="adresse" type="text" required>
              </div>
              <div>
                <label for="zip">Postleitzahl *</label>
                <input id="zip" name="plz" type="text" inputmode="numeric" pattern="\d{5}" placeholder="66557" required>
              </div>
              <div>
                <label for="city">Stadt *</label>
                <input id="city" name="stadt" type="text" required>
              </div>
              <div>
                <label for="mail">E-Mailadresse *</label>
                <input id="mail" name="email" type="email" required>
              </div>
              <div>
                <label for="phone">Telefonnummer *</label>
                <input id="phone" name="telefon" type="tel" required>
              </div>

              <!-- Zusätzliche Adressfelder für weitere Abladestellen -->
              <div id="extraDrops" class="form-grid" style="grid-template-columns:1fr" hidden>
                <div id="drop2">
                  <label for="addr2">Weitere Abladestelle 2 (Adresse)</label>
                  <input id="addr2" name="adresse2" type="text">
                </div>
                <div id="drop3">
                  <label for="addr3">Weitere Abladestelle 3 (Adresse)</label>
                  <input id="addr3" name="adresse3" type="text">
                </div>
                <div id="drop4">
                  <label for="addr4">Weitere Abladestelle 4 (Adresse)</label>
                  <input id="addr4" name="adresse4" type="text">
                </div>
                <div id="drop5">
                  <label for="addr5">Weitere Abladestelle 5 (Adresse)</label>
                  <input id="addr5" name="adresse5" type="text">
                </div>
              </div>

              <div class="form-grid" style="grid-template-columns:1fr">
                <div>
                  <label for="note">Bemerkungen</label>
                  <textarea id="note" name="bemerkungen" placeholder="Tank ist schwer zugänglich / mehr als 40m Schlauch, usw. …"></textarea>
                </div>
              </div>
            </div>

            <div class="newsletter" role="group" aria-labelledby="nlTitle">
              <img src="https://onecdn.io/media/09a82413-99f6-4343-86df-ab9feea45751/full" alt="Newsletter Mockup" loading="lazy" />
              <div>
                <h3 id="nlTitle" class="title">Heizöl-Update & Angebote per Mail erhalten</h3>
                <p>Preis-Update, Spartipps & Aktionen. Jederzeit mit 1 Klick abbestellbar.</p>
                <div class="checkline">
                  <input id="nl" type="checkbox" aria-describedby="nlTitle">
                  <label for="nl">Ja, ich möchte das Heizöl-Update per E-Mail.</label>
                </div>
              </div>
            </div>

            <div class="checkline">
              <input id="agb" type="checkbox" required>
              <label for="agb">AGB akzeptieren *</label>
            </div>
            <div class="checkline">
              <input id="abo" type="checkbox">
              <label for="abo">Ich möchte die Lieferpauschale sparen. Bitte informieren Sie mich unverbindlich über die Möglichkeiten des Heizöl-Abos!</label>
            </div>

            <div class="actions">
              <button class="btn" id="btnOrder" type="button">Jetzt verbindlich bestellen</button>
            </div>
          </section>
        </form>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>© 2026 Raiffeisenmarkt Wiesbach – Alle Rechte vorbehalten</p>
    <p>
      <a href="https://raiffeisenmarkt-wiesbach.onepage.me/impressum" target="_blank" rel="noopener">Impressum</a>
      ·
      <a href="https://raiffeisenmarkt-wiesbach.onepage.me/datenschutzerklarung" target="_blank" rel="noopener">Datenschutz</a>
    </p>
  </footer>

  <!-- Toast + Modal -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="confirm" class="confirm" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="panel">
      <div class="head">
        <span class="check">✓</span>
        <strong id="confirmTitle">Bestellung erfolgreich übermittelt</strong>
      </div>
      <div class="body">
        <div class="grid2">
          <div>
            <table>
              <tr><td><strong>Kunde</strong></td><td id="cName">–</td></tr>
              <tr><td><strong>Kontakt</strong></td><td id="cContact">–</td></tr>
              <tr><td><strong>Adresse</strong></td><td id="cAddr">–</td></tr>
              <tr><td><strong>Newsletter</strong></td><td id="cNL">–</td></tr>
              <tr id="cPremRow" hidden><td><strong>Produkt</strong></td><td>Premium-Öl</td></tr>
            </table>
          </div>
          <div>
            <table>
              <tr><td><strong>Menge</strong></td><td id="cQty">–</td></tr>
              <tr><td><strong>Abladestellen</strong></td><td id="cDrop">–</td></tr>
              <tr><td><strong>Gesamt (netto)</strong></td><td id="cNet">–</td></tr>
              <tr><td><strong>MwSt.</strong></td><td id="cVat">–</td></tr>
              <tr><td><strong>Gesamt (brutto)</strong></td><td id="cGross">–</td></tr>
            </table>
            <p class="hint" id="cIncl">Aufpreise für Rechnung/Express sind – falls ausgewählt – bereits enthalten.</p>
          </div>
        </div>
        <div class="actions">
          <button class="btn secondary" id="btnCloseConfirm" type="button">Schließen</button>
          <button class="btn" id="btnPrintConfirm" type="button">Als PDF drucken</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const euro = (v)=>{ const n = Number(v); if(!isFinite(n)) return '—'; return n.toLocaleString('de-DE',{style:'currency',currency:'EUR'}); }
    const numf = (v)=>{ const n = Number(v); if(!isFinite(n)) return '—'; return n.toLocaleString('de-DE'); }
    function fill(id, val){ const el = document.getElementById(id); if(el) el.textContent = val; }

    let store = {}; try{ store = JSON.parse(sessionStorage.getItem('oelForm')||'{}'); }catch{}
    const b = store?.berechnung || {}; 
    const meta = b.meta||{}; 
    const inp0 = b.input || store?.eingabe || {}; 
    const inp = { plz: inp0.plz || '', liefermengeL: Number(inp0.liefermengeL ?? inp0.liefermenge ?? 0), abladestellen: Number(inp0.abladestellen ?? 1), premium: Boolean(inp0.premium) };
    const k = b.komponentenPro100L||{}; const t = b.totals||{}; const f = b.formatted||{};

    if(!Object.keys(b).length){ const heroTitle = document.querySelector('.price-hero .title-over-price') || document.querySelector('.hero h1'); if(heroTitle) heroTitle.textContent = 'Keine Daten gefunden'; }

    const badge = document.getElementById('premiumBadge'); if(badge) badge.hidden = !inp.premium;

    fill('plz', inp.plz||'—'); fill('ablade', numf(inp.abladestellen||1));

    const price100Base = Number(k.endpreisPro100L ?? (f.endpreisPro100L ? Number(String(f.endpreisPro100L).replace(/[^0-9,.-]/g,'').replace(',','.')): NaN));

    const lpText = (t.lieferpauschaleEinheit!=null && t.lieferpauschaleAnzahl!=null)
      ? `${t.lieferpauschaleAnzahl} × ${euro(t.lieferpauschaleEinheit)} = ${euro(t.lieferpauschale)}`
      : (f.lieferpauschale || euro(t.lieferpauschale));

    fill('warenwert', f.warenwertNetto || euro(t.warenwertNetto));
    fill('pauschale', lpText);
    fill('netto', f.zwischensummeNetto || euro(t.zwischensummeNetto));

    const MWST_SATZ = (t.mwstSatz!=null? Number(t.mwstSatz): 19);
    const MWST_RATE = MWST_SATZ/100;
    const mwstBaseNum = Number(t.mwstBetrag||0);
    const mwstEl = document.getElementById('mwst');
    const mwstOriginal = (f.mwstBetrag || euro(mwstBaseNum)) + ` (${MWST_SATZ}%)`;
    mwstEl.textContent = mwstOriginal;

    const baseBrutto = Number(t.gesamtBrutto || 0);
    const priceBigEl = document.getElementById('priceBig');
    priceBigEl.textContent = (f.gesamtBrutto || euro(baseBrutto));

    const priceNetMainEl = document.getElementById('priceNetMain');
    priceNetMainEl.textContent = (f.zwischensummeNetto || euro(t.zwischensummeNetto));

    const preis100NetEl = document.getElementById('preis100Net');
    const preis100BruttoEl = document.getElementById('preis100Brutto');
    const price100GrossBase = isFinite(price100Base) ? price100Base*(1+MWST_RATE) : NaN;
    preis100NetEl.textContent = isFinite(price100Base) ? euro(price100Base) : '—';
    preis100BruttoEl.textContent = isFinite(price100GrossBase) ? euro(price100GrossBase) : '—';

    document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
    const zipEl = document.getElementById('zip'); if(zipEl && inp.plz) zipEl.value = inp.plz;

    // Zusätzliche Adressfelder je nach Abladestellen anzeigen
    (function(){
      const extraDropsEl = document.getElementById('extraDrops');
      if(!extraDropsEl) return;
      const count = Math.max(1, Math.min(5, Number(inp.abladestellen || 1)));
      let any = false;
      for(let i=2;i<=5;i++){
        const row = document.getElementById('drop'+i);
        if(!row) continue;
        if(i <= count){
          row.style.display = 'flex';
          any = true;
        }else{
          row.style.display = 'none';
        }
      }
      extraDropsEl.hidden = !any;
    })();

    const EXPRESS_SURCHARGE = 100; const INVOICE_SURCHARGE_PER_L = 0.02;
    const expressRow = document.getElementById('expressRow');
    const expressVal = document.getElementById('express');
    const expressHint = document.getElementById('expressHint');
    const invoiceRow = document.getElementById('invoiceRow');
    const invoiceVal = document.getElementById('invoice');
    const invoiceHint = document.getElementById('invoiceHint');

    function isExpressSelected(){ const val = document.querySelector('input[name="delivery"]:checked')?.value || ''; return /1-2\s*Werktage|Express/i.test(val); }
    function isInvoiceSelected(){ const val = document.querySelector('input[name="payment"]:checked')?.value || ''; return /Rechnung/i.test(val); }

    function recalcTotals(){
      let surchargesNet = 0;
      if(isExpressSelected()){ expressRow.style.display = 'flex'; expressVal.textContent = euro(EXPRESS_SURCHARGE); expressHint.style.display = 'block'; surchargesNet += EXPRESS_SURCHARGE; } else { expressRow.style.display = 'none'; expressHint.style.display = 'none'; }
      const invoiceNet = isInvoiceSelected() ? (inp.liefermengeL * INVOICE_SURCHARGE_PER_L) : 0;
      if(invoiceNet > 0){ invoiceRow.style.display = 'flex'; invoiceVal.textContent = euro(invoiceNet); invoiceHint.style.display = 'block'; } else { invoiceRow.style.display = 'none'; invoiceHint.style.display = 'none'; }
      surchargesNet += invoiceNet;
      const mwstNeu = mwstBaseNum + surchargesNet * MWST_RATE; mwstEl.textContent = euro(mwstNeu) + ` (${MWST_SATZ}%)`;
      const bruttoNeu = baseBrutto + surchargesNet * (1 + MWST_RATE); priceBigEl.textContent = euro(bruttoNeu);
      const nettoBase = Number(t.zwischensummeNetto || 0); priceNetMainEl.textContent = euro(nettoBase + surchargesNet);
      const addPer100L = isInvoiceSelected() ? 2 : 0; const net100 = isFinite(price100Base) ? price100Base + addPer100L : NaN; const brutto100 = isFinite(net100) ? net100 * (1 + MWST_RATE) : NaN; preis100NetEl.textContent = isFinite(net100) ? euro(net100) : '—'; preis100BruttoEl.textContent = isFinite(brutto100) ? euro(brutto100) : '—';
    }

    document.querySelectorAll('input[name="delivery"]').forEach(r=> r.addEventListener('change', recalcTotals));
    document.querySelectorAll('input[name="payment"]').forEach(r=> r.addEventListener('change', recalcTotals));
    recalcTotals();

    // ===== UI Helpers =====
    const toast = document.getElementById('toast');
    function showToast(msg, isErr=false){ if(!toast) return; toast.textContent = msg; toast.classList.toggle('err', !!isErr); toast.style.display='block'; setTimeout(()=>{toast.style.display='none';}, 2800); }
    const confirmEl = document.getElementById('confirm');
    function openConfirm(){ confirmEl?.setAttribute('aria-hidden','false'); }
    function closeConfirm(){ confirmEl?.setAttribute('aria-hidden','true'); }
    document.getElementById('btnCloseConfirm').addEventListener('click', closeConfirm);

    // Print nur Modal-Panel
    document.getElementById('btnPrintConfirm').addEventListener('click', ()=>{
      document.body.classList.add('print-only-confirm');
      window.print();
      setTimeout(()=> document.body.classList.remove('print-only-confirm'), 1000);
    });

    // Bestellung absenden
    const btnOrder = document.getElementById('btnOrder');
    btnOrder.addEventListener('click', async ()=>{
      const form = document.getElementById('orderForm');
      if(!form.reportValidity()) return;

      const invoiceNet = isInvoiceSelected() ? (inp.liefermengeL * INVOICE_SURCHARGE_PER_L) : 0;
      const expressNet = isExpressSelected() ? EXPRESS_SURCHARGE : 0;
      const nettoBase = Number(t.zwischensummeNetto || 0);
      const surchargesNet = invoiceNet + expressNet;
      const mwstNeu = Number(t.mwstBetrag||0) + surchargesNet * MWST_RATE;
      const bruttoNeu = Number(t.gesamtBrutto||0) + surchargesNet * (1 + MWST_RATE);
      const addPer100L = isInvoiceSelected() ? 2 : 0; const net100 = isFinite(Number(price100Base)) ? Number(price100Base) + addPer100L : null; const brutto100 = net100!=null ? net100 * (1 + MWST_RATE) : null;

      const payload = {
        order:{
          payment: form.elements['payment']?.value || '',
          delivery: form.elements['delivery']?.value || '',
          vorname: document.getElementById('fn').value.trim(),
          name: document.getElementById('ln').value.trim(),
          firma: document.getElementById('company').value.trim(),
          adresse: document.getElementById('addr').value.trim(),
          plz: document.getElementById('zip').value.trim(),
          stadt: document.getElementById('city').value.trim(),
          email: document.getElementById('mail').value.trim(),
          telefon: document.getElementById('phone').value.trim(),
          bemerkungen: document.getElementById('note').value.trim(),
          agb: document.getElementById('agb').checked,
          newsletter: document.getElementById('nl').checked,
          abo_interesse: document.getElementById('abo').checked,
          adresse2: document.getElementById('addr2') ? document.getElementById('addr2').value.trim() : '',
          adresse3: document.getElementById('addr3') ? document.getElementById('addr3').value.trim() : '',
          adresse4: document.getElementById('addr4') ? document.getElementById('addr4').value.trim() : '',
          adresse5: document.getElementById('addr5') ? document.getElementById('addr5').value.trim() : ''
        },
        fromIndex:{ eingabe: store?.eingabe ?? null, berechnung: store?.berechnung ?? null, timestamp: store?.timestamp ?? null },
        calc:{ meta: meta, input: b.input || inp0 || {}, komponentenPro100L: k, totals: t, formatted: f },
        clientAdjustments:{ invoicePerL: INVOICE_SURCHARGE_PER_L, invoiceNet, expressNet, surchargesNet, net100AfterAdj: net100, gross100AfterAdj: brutto100, nettoGesamtAfterAdj: nettoBase + surchargesNet, mwstAfterAdj: mwstNeu, bruttoGesamtAfterAdj: bruttoNeu },
        meta:{ page:'seite2', submittedAt: new Date().toISOString() }
      };

      btnOrder.disabled = true; const oldTxt = btnOrder.textContent; btnOrder.textContent = 'Senden…';
      try{
        const res = await fetch('https://n8n.srv899952.hstgr.cloud/webhook/oelrechner-bestellung',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const text = await res.text();
        if(!res.ok) throw new Error('HTTP '+res.status+' | '+text.slice(0,200));

        showToast('Bestellung erfolgreich übermittelt.');

        fill('cName', (payload.order.firma? payload.order.firma+' – ' : '') + payload.order.vorname + ' ' + payload.order.name);
        const mailLink = `<a href="mailto:${payload.order.email}">${payload.order.email}</a>`;
        const phoneLink = `<a href="tel:${payload.order.telefon.replace(/\s+/g,'')}">${payload.order.telefon}</a>`;
        document.getElementById('cContact').innerHTML = mailLink + '<br>' + phoneLink;
        fill('cAddr', `${payload.order.adresse}, ${payload.order.plz} ${payload.order.stadt}`);
        fill('cNL', payload.order.newsletter ? 'abonniert' : 'nein');
        document.getElementById('cPremRow').hidden = !inp.premium;
        fill('cQty', numf(inp.liefermengeL) + ' L');
        fill('cDrop', String(inp.abladestellen||1));
        fill('cNet', euro(nettoBase + surchargesNet));
        fill('cVat', euro(mwstNeu) + ` (${MWST_SATZ}%)`);
        fill('cGross', euro(bruttoNeu));
        openConfirm();

        // Weiterleitung nach erfolgreicher Bestellung (z.B. nach 10 Sekunden)
        setTimeout(() => {
          window.location.href = 'https://www.raiffeisenmarkt-wiesbach.de/';
        }, 10000);


      }catch(err){
        showToast('Fehler beim Senden: '+err.message, true);
        if(!toast) alert('Fehler beim Senden: '+err.message);
      }finally{
        btnOrder.disabled = false; btnOrder.textContent = oldTxt;
      }
    });

    /* ===== NUR hinzugefügt: Chart-Logik (ändert keine bestehende Logik) ===== */
    (function initOilChart2(){
      const API = 'https://n8n.srv899952.hstgr.cloud/webhook/oelpreisverlauf';
      const canvas = document.getElementById('oilChart2');
      const metaEl = document.getElementById('oilChartMeta2');
      if(!canvas || !window.Chart) return;

      let chart;

      function fmtDE(iso){
        if(!iso || typeof iso !== 'string') return '';
        const parts = iso.split('-');
        if(parts.length !== 3) return iso;
        const [y,m,d] = parts;
        return `${d}.${m}.${y}`;
      }

      async function load(range){
        try{
          if(metaEl) metaEl.textContent = 'Lade Daten…';
          const res = await fetch(`${API}?range=${encodeURIComponent(range)}`, { cache:'no-store' });
          const data = await res.json();

          const points = Array.isArray(data?.points) ? data.points : [];
          const labels = points.map(p => fmtDE(p.date));
          const values = points.map(p => Number(p.price));
          const finite = values.filter(v => Number.isFinite(v));
          const vMin = finite.length ? Math.min(...finite) : 0;
          const vMax = finite.length ? Math.max(...finite) : 200;

          // Padding macht die Wellen sichtbar (aber bleibt im 0–200 Rahmen)
          const span = Math.max(1, vMax - vMin);
          const pad  = Math.min(18, Math.max(4, span * 0.5));

          const yMin = Math.max(0,  vMin - pad);
          const yMax = Math.min(200, vMax + pad);
          

          const last = data?.last?.date ? fmtDE(data.last.date) : '—';
          if(metaEl) metaEl.textContent = `Zeitraum: ${String(range).toUpperCase()} · Letzter Stand: ${last}`;

          const ctx = canvas.getContext('2d');
          if(chart) chart.destroy();

          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'Tagespreis',
                data: values,
                tension: 0.15,
                borderWidth: 3,
                pointRadius: 0,
                pointHitRadius: 14,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (c) => ` ${Number(c.parsed.y).toLocaleString('de-DE')} €`
                  }
                }
              },
              scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
                y: {
                  min: 60,
                  max: 150,
                  ticks: { callback: (v)=> `${v}` }
                }
              }
            }
          });

        } catch(e){
          if(metaEl) metaEl.textContent = 'Fehler beim Laden der Chart-Daten';
          console.error(e);
        }
      }

      function setActive(btn){
        document.querySelectorAll('.chart-actions .rbtn').forEach(b => b.classList.remove('is-active'));
        btn.classList.add('is-active');
      }

      document.querySelectorAll('.chart-actions .rbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const range = btn.getAttribute('data-range') || '3m';
          setActive(btn);
          load(range);
        });
      });

      load('3m');
    })();
  </script>
</body>
</html>
