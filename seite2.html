<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ölpreisrechner – Bestellung</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #fafafa; color: #333; line-height: 1.5; }

    header { background-color: #6EC054; position: relative; padding: 35px 60px; text-align: center; }
    .logo { height: 40px; }
    .back-button { background-color: white; color: #6EC054; padding: 10px 20px; border: none; border-radius: 20px; font-weight: 600; text-decoration: none; transition: background-color 0.3s ease; position: absolute; right: 60px; top: 50%; transform: translateY(-50%); }
    .back-button:hover { background-color: #e6f0d9; }

    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .step-description { font-size: 0.8rem; }

    /* Ergebnisbereich */
    #webhook-result { max-width: 1000px; margin: 40px auto 20px auto; padding: 25px 30px; background-color: #f9fff1; border: 2px solid #6EC054; border-radius: 16px; box-shadow: 0 6px 15px rgba(110,192,84,0.2); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 1rem; color: #4c7f2d; white-space: pre-wrap; word-wrap: break-word; animation: fadeInDown 0.6s ease forwards; }
    #webhook-result strong { display: block; margin-bottom: 12px; font-size: 1.2rem; }

    /* Formularcontainer */
    .form-container { max-width: 1000px; margin: 20px auto 40px auto; padding: 40px 40px 50px 40px; background: #fff; border-radius: 16px; box-shadow: 0 6px 25px rgba(0,0,0,0.07); border: 2px solid #e5e5e5; font-family: 'Segoe UI', sans-serif; animation: fadeInUp 0.6s ease forwards; }
    h2#bestellformular { margin-top: 0; margin-bottom: 30px; font-weight: 700; color: #4c7f2d; }
    .form-group { margin-bottom: 18px; }
    label { display: block; font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 10px 12px; font-size: 15px; border: 1.8px solid #ccc; border-radius: 10px; outline: none; transition: border-color 0.3s; font-family: 'Segoe UI', sans-serif; min-height: 38px; }
    textarea { min-height: 80px; resize: vertical; }
    input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, select:focus, textarea:focus { border-color: #60993B; box-shadow: 0 0 8px rgba(96,153,59,0.3); }

    button { width: 100%; background: #6EC054; color: white; padding: 16px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s; margin-top: 30px; box-shadow: 0 6px 12px rgba(110,192,84,0.5); }
    button:hover, button:focus { background: #4c7f2d; outline: none; box-shadow: 0 8px 18px rgba(76,127,45,0.8); }

    .checkbox-group { margin-bottom: 14px; font-weight: 500; }
    .checkbox-group input[type="checkbox"] { margin-right: 10px; transform: scale(1.15); vertical-align: middle; cursor: pointer; }
    .checkbox-group label { cursor: pointer; vertical-align: middle; font-weight: 500; color: #333; }

    .alert { max-width: 1000px; margin: 10px auto 0; padding: 10px 14px; border-radius: 8px; font-size: .95rem; display:none; }
    .alert.ok { background:#eaf7e6; color:#2f7d1f; border:1px solid #6EC054; }
    .alert.err { background:#fff1f1; color:#a10000; border:1px solid #ffb3b3; }

    @media (max-width: 1000px) {
      .form-container { padding: 25px 20px 35px 20px; margin: 30px 15px 50px 15px; }
      #webhook-result { margin: 30px 15px 20px 15px; padding: 20px 15px; }
      header { padding: 30px 30px; }
      .back-button { right: 30px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://onecdn.io/media/61c27ecc-efc9-4840-9ff3-d13f96ec1316/full" alt="Logo" class="logo" />
    <a href="index.html" class="back-button">Zurück zum Rechner</a>
  </header>

  <!-- Ergebnis vom Rechner (aus index.html via sessionStorage) -->
  <section id="webhook-result" aria-live="polite" aria-atomic="true">
    <p>Lade Berechnungsergebnis...</p>
  </section>
  <div id="alert-ok" class="alert ok">Bestellung erfolgreich übermittelt. Wir melden uns zeitnah mit dem finalen Angebot.</div>
  <div id="alert-err" class="alert err">Es gab ein Problem beim Senden. Bitte versuche es erneut oder kontaktiere uns.</div>

  <!-- Bestellformular -->
  <main class="form-container" role="main" aria-labelledby="bestellformular">
    <h2 id="bestellformular">Bestellung Heizöl</h2>
    <form id="orderForm" novalidate>
      <!-- Honeypot gegen Bots (nicht ausfüllen) -->
      <div style="position:absolute;left:-5000px;top:auto;width:1px;height:1px;overflow:hidden;">
        <label>Bitte nicht ausfüllen: <input type="text" id="hp_field" name="company" tabindex="-1" autocomplete="off"></label>
      </div>

      <section class="section" aria-label="Kundendaten">
        <h3>Kundendaten</h3>
        <div class="form-group">
          <label for="vorname">Vorname <span class="required">*</span></label>
          <input type="text" id="vorname" name="vorname" required autocomplete="given-name" />
        </div>
        <div class="form-group">
          <label for="nachname">Nachname <span class="required">*</span></label>
          <input type="text" id="nachname" name="nachname" required autocomplete="family-name" />
        </div>
        <div class="form-group">
          <label for="firma">Firma</label>
          <input type="text" id="firma" name="firma" autocomplete="organization" />
        </div>
        <div class="form-group">
          <label for="plz">Postleitzahl <span class="required">*</span></label>
          <input type="text" id="plz" name="plz" pattern="\d{5}" required autocomplete="postal-code" />
        </div>
        <div class="form-group">
          <label for="stadt">Stadt <span class="required">*</span></label>
          <input type="text" id="stadt" name="stadt" required autocomplete="address-level2" />
        </div>
        <div class="form-group">
          <label for="email">E-Mail <span class="required">*</span></label>
          <input type="email" id="email" name="email" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="telefon">Telefonnummer <span class="required">*</span></label>
          <input type="tel" id="telefon" name="telefon" pattern="[\+0-9\s\-]{6,20}" required autocomplete="tel" />
        </div>
      </section>

      <section class="section" aria-label="Bestelldetails">
        <h3>Bestelldetails</h3>
        <div class="form-group">
          <label for="zahlungsmethode">Zahlungsmethode <span class="required">*</span></label>
          <select id="zahlungsmethode" name="zahlungsmethode" required>
            <option value="" disabled selected>Bitte wählen</option>
            <option value="rechnung">Rechnung</option>
            <option value="lastschrift">Lastschrift</option>
            <option value="paypal">PayPal</option>
            <option value="kreditkarte">Kreditkarte</option>
          </select>
        </div>
        <div class="form-group">
          <label for="lieferzeit">Lieferzeit <span class="required">*</span></label>
          <select id="lieferzeit" name="lieferzeit" required>
            <option value="" disabled selected>Bitte wählen</option>
            <option value="sofort">Sofort</option>
            <option value="1-3 tage">1-3 Tage</option>
            <option value="nach absprache">Nach Absprache</option>
          </select>
        </div>
        <div class="form-group">
          <label for="bemerkungen">Bemerkungen</label>
          <textarea id="bemerkungen" name="bemerkungen" placeholder="Hier können Sie zusätzliche Informationen eingeben..."></textarea>
        </div>
      </section>

      <section class="section" aria-label="Optionen">
        <div class="checkbox-group">
          <input type="checkbox" id="agb" name="agb" required />
          <label for="agb">AGB akzeptieren <span class="required">*</span></label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="newsletter" name="newsletter" />
          <label for="newsletter">Newsletter abonnieren</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="abo-info" name="abo_info" />
          <label for="abo-info">Ich möchte die Lieferpauschale sparen. Bitte informieren Sie mich unverbindlich über die Möglichkeiten des Heizöl-Abos!</label>
        </div>
      </section>

      <button type="submit" class="submit-btn" aria-label="Bestellung absenden">Jetzt Bestellung absenden</button>
      <p id="orderStatus" class="info" style="display:none;margin-top:10px"></p>
    </form>
  </main>

  <script>
    // === Einstellungen ===
    const ORDER_WEBHOOK_URL = 'https://n8n.srv899952.hstgr.cloud/webhook/oelrechner-bestellung'; // <-- Anpassen, wenn nötig

    // Format-Helfer
    const euro = (v) => (Number(v)||0).toLocaleString('de-DE', { style:'currency', currency:'EUR' });
    const liter = (v) => (Number(v)||0).toLocaleString('de-DE') + ' Liter';

    function renderResult(container, data){
      if (!data) { container.innerHTML = 'Kein Berechnungsergebnis gefunden. Bitte gehe zurück zum Rechner und starte die Berechnung erneut.'; return; }
      const e = data.eingabe || {};  // liefermenge, plz, abladestellen, area
      const r = data.berechnung || {}; // preisProEinheit (EUR/100l), gesamtPreis (Cent), Margen (Cent), tagespreis

      const preisProLiter = (Number(r.preisProEinheit)||0)/100; // EUR/l
      const gesamt = (Number(r.gesamtPreis)||0)/100; // EUR

      const summary = {
        liefermenge: liter(e.liefermenge),
        plz: e.plz,
        abladestellen: e.abladestellen,
        area: e.area,
        preisPro100l: euro(r.preisProEinheit),
        preisProLiter: euro(preisProLiter),
        gesamtPreis: euro(gesamt),
        tagespreis: typeof r.tagespreis !== 'undefined' ? euro(r.tagespreis) : undefined,
        hauptMarge: typeof r.hauptMarge !== 'undefined' ? euro((Number(r.hauptMarge)||0)/100) : undefined,
        zusatzMarge: typeof r.zusatzMarge !== 'undefined' ? euro((Number(r.zusatzMarge)||0)/100) : undefined,
        gesamtMarge: typeof r.gesamtMarge !== 'undefined' ? euro((Number(r.gesamtMarge)||0)/100) : undefined
      };
      const shown = Object.fromEntries(Object.entries(summary).filter(([_,v]) => v!==undefined));
      container.innerHTML = '<strong>Berechnungsergebnis:</strong><pre>' + JSON.stringify(shown, null, 2) + '</pre>';

      if (e.plz) document.getElementById('plz').value = e.plz;
    }

    function showAlert(id, on=true){ const el = document.getElementById(id); if(!el) return; el.style.display = on ? 'block' : 'none'; }

    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('webhook-result');
      let data = null; try { const raw = sessionStorage.getItem('oelForm'); if (raw) data = JSON.parse(raw); } catch {}
      renderResult(container, data);

      const form = document.getElementById('orderForm');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        showAlert('alert-ok', false); showAlert('alert-err', false);

        const hp = document.getElementById('hp_field');
        if (hp && hp.value) { showAlert('alert-err', true); return; }

        const requiredIds = ['vorname','nachname','plz','stadt','email','telefon','zahlungsmethode','lieferzeit','agb'];
        for (const id of requiredIds) {
          const el = document.getElementById(id);
          if (!el) continue;
          if ((el.type === 'checkbox' && !el.checked) || (!el.value)) {
            el.focus();
            showAlert('alert-err', true);
            return;
          }
        }

        if (!data) { showAlert('alert-err', true); return; }

        const payload = {
          orderId: 'ORD-' + Date.now(),
          kundendaten: {
            vorname: document.getElementById('vorname').value.trim(),
            nachname: document.getElementById('nachname').value.trim(),
            firma: document.getElementById('firma').value.trim(),
            plz: document.getElementById('plz').value.trim(),
            stadt: document.getElementById('stadt').value.trim(),
            email: document.getElementById('email').value.trim(),
            telefon: document.getElementById('telefon').value.trim(),
          },
          bestelldetails: {
            zahlungsmethode: document.getElementById('zahlungsmethode').value,
            lieferzeit: document.getElementById('lieferzeit').value,
            bemerkungen: document.getElementById('bemerkungen').value.trim(),
            agb: document.getElementById('agb').checked,
            newsletter: document.getElementById('newsletter').checked,
            abo_info: document.getElementById('abo-info').checked
          },
          eingabe: data.eingabe,
          berechnung: data.berechnung,
          meta: {
            ts: new Date().toISOString(),
            page: location.href,
            userAgent: navigator.userAgent
          }
        };

        // FormData → kein Preflight
        const fd = new FormData();
        fd.append('payload', JSON.stringify(payload));

        try {
          const res = await fetch(ORDER_WEBHOOK_URL, { method: 'POST', body: fd });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          let reply = null; try { reply = await res.json(); } catch {}

          if (reply && (reply.ok === true || reply.success === true)){
            showAlert('alert-ok', true);
            document.getElementById('orderStatus').textContent = `Bestellung erfolgreich übermittelt. Bestell-ID: ${reply.orderId || payload.orderId}`;
            document.getElementById('orderStatus').style.display = 'block';
            sessionStorage.setItem('lastOrderId', reply.orderId || payload.orderId);
          } else {
            showAlert('alert-err', true);
            document.getElementById('orderStatus').textContent = 'Bestellung gesendet, aber Serverantwort war unerwartet.';
            document.getElementById('orderStatus').style.display = 'block';
          }
        } catch (err){
          console.error(err);
          showAlert('alert-err', true);
          document.getElementById('orderStatus').textContent = 'Senden fehlgeschlagen. Bitte später erneut versuchen.';
          document.getElementById('orderStatus').style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>