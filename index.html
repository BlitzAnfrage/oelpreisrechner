<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Ölpreisrechner</title>
  <link rel="icon" href="https://onecdn.io/media/96d496c9-3b9e-451e-ab59-264290e9b0cf/full" sizes="any" />
  <meta name="theme-color" content="#6EC054" />
  <style>
    :root{
      --brand:#6EC054; --brand-dark:#4c7f2d; --ink:#222; --bg:#f7faf7; --card:#ffffff;
      --muted:#6b6b6b; --ring:rgba(110,192,84,.25); --shadow:0 12px 30px rgba(0,0,0,.08);
      --chart-max-width: 1000px;
    }
    *{box-sizing:border-box}
    html{font-size:15px; overflow-x:hidden; width:100%; max-width:100vw}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--ink);font-weight:400;overflow-x:hidden; width:100%; max-width:100vw; overscroll-behavior-x:none; touch-action:pan-y; -webkit-text-size-adjust:100%}

    header{background:var(--brand);position:relative;text-align:center;color:#fff;
      padding:26px 60px;
      padding-top:calc(26px + constant(safe-area-inset-top));
      padding-left:calc(60px + constant(safe-area-inset-left));
      padding-right:calc(60px + constant(safe-area-inset-right));
      padding-top:calc(26px + env(safe-area-inset-top));
      padding-left:calc(60px + env(safe-area-inset-left));
      padding-right:calc(60px + env(safe-area-inset-right));
    }
    .logo{height:40px}

    .hero{padding:2.5rem 1rem;background:#fff;text-align:center;border-bottom:1px solid #eef2ea}
    .hero h1{margin:0;font-size:clamp(1.4rem,2.1vw,1.9rem);font-weight:700;letter-spacing:.2px;display:inline-block;background:var(--brand);color:#fff;padding:.55rem .9rem;border-radius:10px}
    .hero p{margin:.75rem auto 0;max-width:1000px;color:#2d2d2d;font-size:1rem;font-weight:400}
    .hero-media{display:none}

    .steps{max-width:1000px;margin:1rem auto;background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:.8rem 1rem}
    .steps ol{list-style:none;display:grid;grid-template-columns:repeat(4,1fr);gap:.85rem;padding:0;margin:0}
    .steps li{display:flex;gap:.65rem;align-items:flex-start;padding:.6rem .6rem;border-radius:10px}
    .steps .dot{flex:0 0 30px;height:30px;border-radius:50%;background:var(--brand);color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:.95rem}
    .steps .txt{font-size:.9rem;line-height:1.25}
    .steps .txt strong{font-weight:700}

    .form-wrap{padding:1.2rem}
    .form{max-width:1000px;margin:0 auto;background:var(--card);border:1px solid #e8efe3;border-radius:16px;padding:22px 22px 26px;box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:26px;margin-bottom:22px}
    .form-group{display:flex;flex-direction:column}
    label{font-weight:600;font-size:.92rem;margin-bottom:.35rem;color:#1f2b1c}
    input[type="text"],select{border:1.7px solid #d9e3d3;border-radius:10px;padding:10px 12px;font-size:.95rem;outline:none;transition:.2s;background:#fff}
    input[type="text"]:focus,select:focus{border-color:var(--brand-dark);box-shadow:0 0 0 4px var(--ring)}
    input[type="number"]{border:1.7px solid #d9e3d3;border-radius:10px;padding:10px 12px;font-size:.95rem;outline:none;transition:.2s;background:#fff}
    input[type="number"]:focus{border-color:var(--brand-dark);box-shadow:0 0 0 4px var(--ring)}
    .number-wrap{position:relative}
    .unit-input{display:flex;align-items:center;gap:8px}
    .unit-input .unit{font-weight:700;color:#1f2b1c}
    .hint{display:block;margin-top:.35rem;color:#315227}

    .premium-card{border:1px solid #e8efe3;border-radius:12px;padding:14px;background:#fbfdf9}
    .switch{position:relative;display:inline-flex;align-items:center;gap:.6rem}
    .switch input{position:absolute;left:0;top:0;width:48px;height:26px;opacity:0;cursor:pointer}
    .slider{width:48px;height:26px;border-radius:999px;background:#d9e3d3;position:relative;transition:.2s;cursor:pointer}
    .slider::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25);transition:.2s}
    .switch input:checked + .slider{background:var(--brand)}
    .switch input:checked + .slider::after{left:25px}
    .switch-label{font-weight:700;font-size:.95rem}

    details{margin-top:.35rem}
    details summary{cursor:pointer;font-weight:600;color:#224219;outline:none}
    details[open] summary{color:#142d0e}
    .info{font-size:.9rem;color:#233221;line-height:1.45}

    .btn{margin-top:6px;width:100%;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:14px;font-weight:700;font-size:1rem;cursor:pointer;transition:transform .02s,background .15s}
    .btn:hover,.btn:focus{background:var(--brand-dark);outline:none}
    .btn:active{transform:translateY(1px)}

    .footer{margin-top:34px;background:var(--brand);color:#fff;text-align:center;padding:24px 12px;font-size:.95rem}
    .footer a{color:#fff;text-decoration:underline}

    /* ====== Chart Card ====== */
    .chart-card{
      max-width:var(--chart-max-width);
      width:calc(100% - 2rem);
      margin:34px auto 0;
      background:#fff;
      border-radius:16px;
      box-shadow:var(--shadow);
      border:1px solid #e8efe3;
      overflow:hidden;
    }
    .chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 10px;
      border-bottom:1px solid #eef2ea;
      flex-wrap:wrap;
    }
    .chart-head h2{margin:0;font-size:1.05rem}
    .range-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .range-buttons button{
      border:1px solid #d9e3d3;
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .range-buttons button.active{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }
    .chart-body{padding:12px 14px 16px}
    .chart-note{color:#555;font-size:.9rem;margin:0 0 10px}
    .chart-error{display:none;color:#b00020;font-weight:700;margin:8px 0 0}

    /* Fix: Chart-Höhe stabil */
    #oilChartWrap{position:relative;height:260px}
    canvas{max-width:100%}

    @media (min-width:901px){
      .form{padding-bottom:32px}
      .steps ol{align-items:stretch}
      .steps li{min-height:96px}
      .steps{margin:1.6rem auto 2.2rem}
      .form-wrap{padding-top:2rem; padding-bottom:2.2rem}
      .footer{margin-top:48px}
    }

    @media (max-width:900px){
      .steps ol{grid-template-columns:1fr 1fr}
      .row{grid-template-columns:1fr;margin-bottom:24px}
      header{
        padding:24px 22px;
        padding-top:calc(24px + env(safe-area-inset-top));
        padding-left:calc(22px + env(safe-area-inset-left));
        padding-right:calc(22px + env(safe-area-inset-right));
      }
      #oilChartWrap{height:220px}
    }
  </style>
</head>

<body>
  <header>
    <img src="https://onecdn.io/media/61c27ecc-efc9-4840-9ff3-d13f96ec1316/full" alt="Logo Raiffeisenmarkt Wiesbach" class="logo" />
  </header>

  <section class="hero" aria-labelledby="h1">
    <h1 id="h1">Heizöl Preisrechner – Raiffeisenmarkt Wiesbach im Saarland</h1>
    <p>Berechnen Sie Ihren Heizölpreis schnell und bequem – ganz einfach online und sofort verfügbar.</p>
  </section>

  <section class="steps" aria-label="Schritte">
    <ol>
      <li><div class="dot">1</div><div class="txt"><strong>Daten eingeben</strong><br><span>PLZ, Liefermenge &amp; Versandart wählen</span></div></li>
      <li><div class="dot">2</div><div class="txt"><strong>Preis berechnen</strong><br><span>Individuellen Preis berechnen lassen</span></div></li>
      <li><div class="dot">3</div><div class="txt"><strong>Bestellung abschicken</strong><br><span>Persönliche Daten bestätigen &amp; Formular verbindlich absenden</span></div></li>
      <li><div class="dot">4</div><div class="txt"><strong>Lieferung &amp; Zahlung</strong><br><span>Bezahlung bei Lieferung oder per Vorabüberweisung</span></div></li>
    </ol>
  </section>

  <section class="form-wrap">
    <form id="oilForm" class="form" novalidate>
      <div class="row">
        <div class="form-group">
          <label for="oilRange">Liefermenge (Liter)*</label>
          <div class="number-wrap">
            <div class="unit-input">
              <input type="number" id="oilRange" name="liefermenge" min="100" max="15000" step="100" value="500" inputmode="numeric" required />
              <span class="unit">L</span>
            </div>
            <small class="hint">• Schritte à 100 L •</small>
          </div>
        </div>
        <div class="form-group">
          <label for="plz">Postleitzahl*</label>
          <input type="text" id="plz" name="plz" maxlength="5" inputmode="numeric" pattern="\d{5}" required placeholder="z. B. 66557" />
          <p id="errMsg" style="display:none;color:#b00020;font-weight:600;margin:.35rem 0 0" aria-live="assertive">Die eingegebene PLZ liegt nicht im Liefergebiet.</p>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="ablade">Anzahl der Abladestellen*</label>
          <select id="ablade" name="ablade" required>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>

        <div class="form-group">
          <div class="premium-card" role="group" aria-labelledby="premiumTitle">
            <div class="switch">
              <input type="checkbox" id="premium" aria-describedby="premiumHint" />
              <span class="slider" aria-hidden="true"></span>
              <label for="premium" class="switch-label" id="premiumTitle">Premium Heizöl</label>
            </div>
            <small id="premiumHint" class="muted" style="display:block;color:#315227;margin-top:.3rem">Aufpreis: +1,50 € je 100 L – wird bei der Berechnung berücksichtigt.</small>
          </div>
        </div>
      </div>

      <button class="btn" id="submitBtn" type="submit">Preis berechnen</button>
    </form>
  </section>

  <!-- CHART -->
  <section class="chart-card" aria-label="Heizölpreis-Verlauf">
    <div class="chart-head">
      <h2>Heizölpreis-Verlauf</h2>
      <div class="range-buttons">
        <button type="button" class="rangeBtn active" data-range="3m">3 Monate</button>
        <button type="button" class="rangeBtn" data-range="6m">6 Monate</button>
        <button type="button" class="rangeBtn" data-range="1y">1 Jahr</button>
        <button type="button" class="rangeBtn" data-range="3y">3 Jahre</button>
      </div>
    </div>
    <div class="chart-body">
      <p class="chart-note" id="rangeLabel">Zeitraum: 3 Monate</p>
      <div id="oilChartWrap">
        <canvas id="oilChart"></canvas>
      </div>
      <p class="chart-error" id="chartErr"></p>
    </div>
  </section>

  <footer class="footer">
    <p>© 2025 Raiffeisenmarkt Wiesbach – Alle Rechte vorbehalten</p>
    <p>
      <a href="https://raiffeisenmarkt-wiesbach.onepage.me/impressum" target="_blank" rel="noopener">Impressum</a>
      ·
      <a href="https://raiffeisenmarkt-wiesbach.onepage.me/datenschutzerklarung" target="_blank" rel="noopener">Datenschutzerklärung</a>
    </p>
  </footer>

  <!-- Chart.js + Time Adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <script>
    // ========= FORM (wie gehabt) =========
    const oilSlider = document.getElementById('oilRange');
    const FORM = document.getElementById('oilForm');
    const BTN  = document.getElementById('submitBtn');
    const ERR  = document.getElementById('errMsg');

    (function(){
      const MIN = 100, MAX = 15000, STEP = 100;
      function normalize(v){
        let n = parseInt(String(v).replace(/\D+/g,''), 10);
        if (isNaN(n)) n = MIN;
        n = Math.round(n / STEP) * STEP;
        n = Math.max(MIN, Math.min(MAX, n));
        return n;
      }
      if(oilSlider){
        oilSlider.addEventListener('blur',  ()=> oilSlider.value = normalize(oilSlider.value));
        oilSlider.addEventListener('change',()=> oilSlider.value = normalize(oilSlider.value));
      }
    })();

    // ========= CHART (funktioniert sicher + Cache-Fix + Monats-Achse) =========
    const chartErr = document.getElementById('chartErr');
    const rangeLabel = document.getElementById('rangeLabel');
    const rangeBtns = Array.from(document.querySelectorAll('.rangeBtn'));
    let chartInstance = null;

    function setActiveRangeBtn(range){
      rangeBtns.forEach(b => b.classList.toggle('active', b.dataset.range === range));
      const label =
        range === '3m' ? '3 Monate' :
        range === '6m' ? '6 Monate' :
        range === '1y' ? '1 Jahr' :
        range === '3y' ? '3 Jahre' : range;
      rangeLabel.textContent = 'Zeitraum: ' + label;
    }

    async function loadChart(range){
      chartErr.style.display = 'none';
      chartErr.textContent = '';
      setActiveRangeBtn(range);

      // Cachebuster, damit 6m/1y nicht wie 3m "gecacht" wird
      const url = `https://n8n.srv899952.hstgr.cloud/webhook/oelchart?range=${encodeURIComponent(range)}&_=${Date.now()}`;

      let payload;
      try{
        const res = await fetch(url, { method: 'GET', cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);

        payload = await res.json();
        if (Array.isArray(payload)) payload = payload[0];

        const labels = payload?.labels;
        const data   = payload?.data;

        if(!payload || !Array.isArray(labels) || !Array.isArray(data) || labels.length !== data.length){
          throw new Error('Unerwartete Antwort: labels/data fehlen oder Länge passt nicht');
        }

        // Punkte für Time-Scale (labels müssen "YYYY-MM-DD" sein)
        const points = labels.map((d, i) => ({ x: d, y: data[i] }));

        const ctx = document.getElementById('oilChart');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Heizölpreis',
              data: points,
              borderColor: '#6EC054',
              backgroundColor: 'rgba(110,192,84,0.15)',
              tension: 0.3,
              fill: true,
              pointRadius: 0,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: (items) => {
                    // Datum schön im Tooltip: DD.MM.YYYY
                    const d = items?.[0]?.parsed?.x;
                    if (!d) return '';
                    const dt = new Date(d);
                    const dd = String(dt.getDate()).padStart(2,'0');
                    const mm = String(dt.getMonth()+1).padStart(2,'0');
                    const yy = dt.getFullYear();
                    return `${dd}.${mm}.${yy}`;
                  },
                  label: (ctx) => ` ${ctx.parsed.y} €`
                }
              }
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'month',
                  displayFormats: { month: 'MM/yy' }
                },
                ticks: {
                  maxRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: 8
                },
                grid: { display: false }
              },
              y: {
                beginAtZero: false,
                ticks: { callback: (v) => v + ' €' }
              }
            }
          }
        });

      } catch(e){
        chartErr.style.display = 'block';
        chartErr.textContent = 'Chart konnte nicht geladen werden: ' + e.message;
      }
    }

    rangeBtns.forEach(btn => {
      btn.addEventListener('click', () => loadChart(btn.dataset.range));
    });

    loadChart('3m');
  </script>
</body>
</html>
